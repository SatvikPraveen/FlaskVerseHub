<!-- File: app/knowledge_vault/templates/vault_detail.html -->
{% extends "base.html" %} {% block title %}{{ entry.title }} - Knowledge Vault{%
endblock %} {% block extra_css %}
<link
  rel="stylesheet"
  href="{{ url_for('knowledge_vault.static', filename='css/vault.css') }}"
/>
<link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.28.0/themes/prism.min.css"
/>
{% endblock %} {% block content %}
<div class="entry-detail-container">
  <!-- Breadcrumb Navigation -->
  <nav class="breadcrumb">
    <a href="{{ url_for('knowledge_vault.index') }}">Knowledge Vault</a>
    <span class="breadcrumb-separator">â€º</span>
    <span class="breadcrumb-current">{{ entry.title|truncate(50) }}</span>
  </nav>

  <!-- Entry Header -->
  <header class="entry-detail-header">
    <div class="header-meta">
      <span class="entry-category category-{{ entry.category }}"
        >{{ entry.category|title }}</span
      >
      {% if entry.is_featured %}
      <span class="featured-badge">Featured</span>
      {% endif %} {% if not entry.is_public %}
      <span class="private-badge">Private</span>
      {% endif %}
      <time class="entry-date"
        >{{ entry.created_at.strftime('%B %d, %Y at %I:%M %p') }}</time
      >
    </div>

    <h1 class="entry-title">{{ entry.title }}</h1>

    {% if entry.description %}
    <p class="entry-description">{{ entry.description }}</p>
    {% endif %}

    <div class="entry-actions">
      {% if current_user.is_authenticated and (entry.author == current_user or
      current_user.is_admin) %}
      <div class="owner-actions">
        <a
          href="{{ url_for('knowledge_vault.edit', id=entry.id) }}"
          class="btn btn-outline"
        >
          <i class="icon-edit"></i> Edit Entry
        </a>
        <button class="btn btn-danger" onclick="confirmDelete()">
          <i class="icon-trash"></i> Delete Entry
        </button>
      </div>
      {% endif %}

      <div class="share-actions">
        <button
          class="btn btn-outline"
          onclick="copyToClipboard('{{ request.url }}')"
        >
          <i class="icon-link"></i> Copy Link
        </button>
        <button class="btn btn-outline" onclick="printEntry()">
          <i class="icon-printer"></i> Print
        </button>
      </div>
    </div>
  </header>

  <!-- Entry Content -->
  <main class="entry-content">
    <div class="content-wrapper">
      <!-- Main Content -->
      <div class="main-content">
        <div class="content-body">{{ entry.content|safe }}</div>

        <!-- Source URL -->
        {% if entry.source_url %}
        <div class="source-section">
          <h4>Source</h4>
          <a
            href="{{ entry.source_url }}"
            target="_blank"
            rel="noopener noreferrer"
            class="source-link"
          >
            <i class="icon-external-link"></i>
            {{ entry.source_url }}
          </a>
        </div>
        {% endif %}

        <!-- Attachment -->
        {% if entry.attachment_filename %}
        <div class="attachment-section">
          <h4>Attachment</h4>
          <div class="attachment-item">
            <i class="icon-attachment"></i>
            <a
              href="{{ url_for('static', filename='uploads/vault/' + entry.attachment_filename) }}"
              target="_blank"
              class="attachment-link"
            >
              {{ entry.attachment_filename }}
            </a>
          </div>
        </div>
        {% endif %}

        <!-- Tags -->
        {% if entry.tags %}
        <div class="tags-section">
          <h4>Tags</h4>
          <div class="entry-tags">
            {% for tag in entry.tags.split(',') %}
            <a
              href="{{ url_for('knowledge_vault.index', query=tag.strip()) }}"
              class="tag"
            >
              {{ tag.strip() }}
            </a>
            {% endfor %}
          </div>
        </div>
        {% endif %}

        <!-- Entry Footer -->
        <footer class="entry-footer">
          <div class="author-info">
            <div class="author-details">
              <strong>Author:</strong> {{ entry.author.username if entry.author
              else 'Unknown' }}
            </div>
            {% if entry.updated_at and entry.updated_at != entry.created_at %}
            <div class="update-info">
              <small
                >Last updated: {{ entry.updated_at.strftime('%B %d, %Y at %I:%M
                %p') }}</small
              >
            </div>
            {% endif %}
          </div>
        </footer>
      </div>

      <!-- Sidebar -->
      <aside class="content-sidebar">
        <!-- Table of Contents -->
        <div class="sidebar-section">
          <h4>Table of Contents</h4>
          <nav class="toc" id="tableOfContents">
            <!-- Generated by JavaScript -->
          </nav>
        </div>

        <!-- Related Entries -->
        {% if related_entries %}
        <div class="sidebar-section">
          <h4>Related Entries</h4>
          <div class="related-entries">
            {% for related in related_entries %}
            <div class="related-entry">
              <h5>
                <a
                  href="{{ url_for('knowledge_vault.detail', id=related.id) }}"
                >
                  {{ related.title|truncate(60) }}
                </a>
              </h5>
              <div class="related-meta">
                <span class="related-category"
                  >{{ related.category|title }}</span
                >
                <span class="related-date"
                  >{{ related.created_at.strftime('%b %d, %Y') }}</span
                >
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
        {% endif %}

        <!-- Quick Actions -->
        <div class="sidebar-section">
          <h4>Quick Actions</h4>
          <div class="quick-actions">
            <button class="action-btn" onclick="scrollToTop()">
              <i class="icon-arrow-up"></i> Back to Top
            </button>
            <button class="action-btn" onclick="toggleReadingMode()">
              <i class="icon-book"></i> Reading Mode
            </button>
            <button class="action-btn" onclick="increaseFontSize()">
              <i class="icon-plus"></i> Larger Text
            </button>
            <button class="action-btn" onclick="decreaseFontSize()">
              <i class="icon-minus"></i> Smaller Text
            </button>
          </div>
        </div>
      </aside>
    </div>
  </main>

  <!-- Navigation -->
  <nav class="entry-navigation">
    <a href="{{ url_for('knowledge_vault.index') }}" class="nav-link">
      <i class="icon-arrow-left"></i> Back to Knowledge Vault
    </a>
    <div class="nav-spacer"></div>
    {% if current_user.is_authenticated %}
    <a href="{{ url_for('knowledge_vault.create') }}" class="nav-link">
      <i class="icon-plus"></i> Create New Entry
    </a>
    {% endif %}
  </nav>
</div>

<!-- Delete Confirmation Modal -->
{% if current_user.is_authenticated and (entry.author == current_user or
current_user.is_admin) %}
<div id="deleteModal" class="modal" style="display: none">
  <div class="modal-content">
    <h3>Confirm Deletion</h3>
    <p>Are you sure you want to delete "{{ entry.title }}"?</p>
    <div class="modal-actions">
      <button class="btn btn-outline" onclick="closeDeleteModal()">
        Cancel
      </button>
      <form
        method="POST"
        action="{{ url_for('knowledge_vault.delete', id=entry.id) }}"
        style="display: inline"
      >
        {{ csrf_token() }}
        <button type="submit" class="btn btn-danger">Delete</button>
      </form>
    </div>
  </div>
</div>
{% endif %}

<!-- Reading Mode Overlay -->
<div id="readingMode" class="reading-mode" style="display: none">
  <div class="reading-header">
    <h1>{{ entry.title }}</h1>
    <button class="close-reading" onclick="toggleReadingMode()">
      <i class="icon-x"></i>
    </button>
  </div>
  <div class="reading-content">
    <!-- Content will be cloned here -->
  </div>
</div>
{% endblock %} {% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.28.0/components/prism-core.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.28.0/plugins/autoloader/prism-autoloader.min.js"></script>
<script src="{{ url_for('knowledge_vault.static', filename='js/vault.js') }}"></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Generate table of contents
    generateTableOfContents();

    // Syntax highlighting
    if (window.Prism) {
      Prism.highlightAll();
    }

    // Smooth scrolling for anchor links
    document.querySelectorAll('a[href^="#"]').forEach((anchor) => {
      anchor.addEventListener("click", function (e) {
        e.preventDefault();
        const target = document.querySelector(this.getAttribute("href"));
        if (target) {
          target.scrollIntoView({
            behavior: "smooth",
            block: "start",
          });
        }
      });
    });
  });

  function generateTableOfContents() {
    const toc = document.getElementById("tableOfContents");
    const headings = document.querySelectorAll(
      ".content-body h1, .content-body h2, .content-body h3, .content-body h4"
    );

    if (headings.length === 0) {
      toc.innerHTML = '<p class="no-toc">No headings found</p>';
      return;
    }

    let tocHTML = '<ul class="toc-list">';

    headings.forEach((heading, index) => {
      const id = `heading-${index}`;
      heading.id = id;

      const level = parseInt(heading.tagName.substring(1));
      const text = heading.textContent;

      tocHTML += `
            <li class="toc-item toc-level-${level}">
                <a href="#${id}" class="toc-link">${text}</a>
            </li>
        `;
    });

    tocHTML += "</ul>";
    toc.innerHTML = tocHTML;
  }

  function confirmDelete() {
    document.getElementById("deleteModal").style.display = "flex";
  }

  function closeDeleteModal() {
    document.getElementById("deleteModal").style.display = "none";
  }

  function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(
      function () {
        showNotification("Link copied to clipboard!", "success");
      },
      function (err) {
        showNotification("Failed to copy link", "error");
      }
    );
  }

  function printEntry() {
    window.print();
  }

  function scrollToTop() {
    window.scrollTo({
      top: 0,
      behavior: "smooth",
    });
  }

  let readingModeActive = false;

  function toggleReadingMode() {
    const readingMode = document.getElementById("readingMode");
    const body = document.body;

    if (!readingModeActive) {
      // Enter reading mode
      const content = document.querySelector(".content-body").cloneNode(true);
      document.querySelector(".reading-content").innerHTML = "";
      document.querySelector(".reading-content").appendChild(content);

      readingMode.style.display = "block";
      body.style.overflow = "hidden";
      readingModeActive = true;
    } else {
      // Exit reading mode
      readingMode.style.display = "none";
      body.style.overflow = "auto";
      readingModeActive = false;
    }
  }

  let currentFontSize = 16;

  function increaseFontSize() {
    currentFontSize += 2;
    document.querySelector(".content-body").style.fontSize =
      currentFontSize + "px";
    showNotification("Font size increased", "info");
  }

  function decreaseFontSize() {
    if (currentFontSize > 12) {
      currentFontSize -= 2;
      document.querySelector(".content-body").style.fontSize =
        currentFontSize + "px";
      showNotification("Font size decreased", "info");
    }
  }

  function showNotification(message, type) {
    const notification = document.createElement("div");
    notification.className = `notification notification-${type}`;
    notification.textContent = message;

    document.body.appendChild(notification);

    setTimeout(() => {
      notification.classList.add("show");
    }, 100);

    setTimeout(() => {
      notification.classList.remove("show");
      setTimeout(() => {
        document.body.removeChild(notification);
      }, 300);
    }, 3000);
  }

  // Close modal when clicking outside
  document
    .getElementById("deleteModal")
    .addEventListener("click", function (e) {
      if (e.target === this) {
        closeDeleteModal();
      }
    });

  // Close reading mode with Escape key
  document.addEventListener("keydown", function (e) {
    if (e.key === "Escape" && readingModeActive) {
      toggleReadingMode();
    }
  });
</script>
{% endblock %}
